apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-config
  namespace: {{ .Values.global.namespace | default "web-services" }}
data:
  config.yaml: |
    general_settings:
      database_url: "{{ .Values.secrets.databaseUrl }}"
      database_connection_pool_limit: 100
      database_connection_timeout: 60
      allow_requests_on_db_unavailable: true
      master_key: "{{ .Values.secrets.litellmMasterKey }}"
      user_header_mappings:
        - header_name: X-OpenWebUI-User-Id
          litellm_user_role: customer
        # Rate limiting is currently based on customer/end-user, which should use the user-id.
        # - header_name: X-OpenWebUI-User-Email
        #   litellm_user_role: customer
      enforce_user_param: false
      store_prompts_in_spend_logs: true
      custom_auth: custom_auth.user_api_key_auth
      custom_auth_settings:
        mode: "auto"

    router_settings:
      routing_strategy: "{{ .Values.router.routingStrategy }}"
      # Redis disabled - using simple-shuffle strategy doesn't require persistent state
      # redis_host: "{{ .Values.secrets.redisHost }}"
      # redis_port: {{ .Values.env.litellmRedisPort }}
      # redis_url: "{{ .Values.secrets.redisUrl }}"

    litellm_settings:
      {{- if .Values.config.litellm_settings }}
      {{- if hasKey .Values.config.litellm_settings "cache" }}
      cache: {{ .Values.config.litellm_settings.cache }}
      {{- if .Values.config.litellm_settings.cache_params }}
      cache_params:
        type: {{ .Values.config.litellm_settings.cache_params.type }}
        {{- if .Values.config.litellm_settings.cache_params.namespace }}
        namespace: {{ .Values.config.litellm_settings.cache_params.namespace | quote }}
        {{- end }}
        {{- if .Values.config.litellm_settings.cache_params.ttl }}
        ttl: {{ .Values.config.litellm_settings.cache_params.ttl }}
        {{- end }}
      {{- end }}
      {{- else }}
      cache: false
      {{- end }}
      {{- else }}
      cache: false
      {{- end }}
      drop_params: true
      {{- if .Values.lago.enabled }}
      # Custom Lago billing integration with separate input/output events
      callbacks: ["custom_lago_callback.lago_callback"]
      {{- end }}
      extra_spend_tag_headers:
        - "x-openwebui-user-id"
        - "x-openwebui-user-email"
        - "x-openwebui-user-name"
        - "x-zuplo-user-id"
        
    model_list:
    {{- range .Values.config.models }}
    - model_name: {{ .model_name }}
      litellm_params:
        model: {{ .litellm_params.model }}
        {{- if .litellm_params.aws_region_name }}
        aws_region_name: {{ .litellm_params.aws_region_name }}
        {{- end }}
        {{- if .litellm_params.api_base }}
        api_base: {{ .litellm_params.api_base }}
        {{- end }}
        {{- if .litellm_params.api_key }}
        api_key: {{ .litellm_params.api_key | quote }}
        {{- end }}
        {{- if .litellm_params.weight }}
        weight: {{ .litellm_params.weight }}
        {{- end }}
        {{- if .litellm_params.temperature }}
        temperature: {{ .litellm_params.temperature }}
        {{- end }}
        {{- if .litellm_params.top_p }}
        top_p: {{ .litellm_params.top_p }}
        {{- end }}
        {{- if .litellm_params.max_tokens }}
        max_tokens: {{ .litellm_params.max_tokens }}
        {{- end }}
      {{- if .model_info }}
      model_info:
        {{- if .model_info.input_cost_per_token }}
        input_cost_per_token: {{ .model_info.input_cost_per_token }}
        {{- end }}
        {{- if .model_info.output_cost_per_token }}
        output_cost_per_token: {{ .model_info.output_cost_per_token }}
        {{- end }}
      {{- end }}
    {{- end }}
    
    {{- if .Values.config.guardrails }}
    guardrails:
    {{- range .Values.config.guardrails }}
    - guardrail_name: {{ .guardrail_name | quote }}
      litellm_params:
        guardrail: {{ .litellm_params.guardrail }}
        mode: {{ .litellm_params.mode | quote }}
        guardrailIdentifier: {{ .litellm_params.guardrailIdentifier | quote }}
        guardrailVersion: {{ .litellm_params.guardrailVersion | quote }}
        aws_region_name: {{ .litellm_params.aws_region_name | quote }}
        {{- if .litellm_params.disable_exception_on_block }}
        disable_exception_on_block: {{ .litellm_params.disable_exception_on_block }}
        {{- end }}
        {{- if .litellm_params.default_on }}
        default_on: {{ .litellm_params.default_on }}
        {{- end }}
    {{- end }}
    {{- end }}