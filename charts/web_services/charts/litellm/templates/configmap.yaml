apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Values.app.name }}-config
  namespace: {{ .Values.global.namespace | default "web-services" }}
data:
  config.yaml: |
    general_settings:
      database_url: "{{ .Values.secrets.databaseUrl }}"
      database_connection_pool_limit: 100
      database_connection_timeout: 60
      allow_requests_on_db_unavailable: true
      master_key: "{{ .Values.secrets.litellmMasterKey }}"
      user_header_mappings:
        - header_name: X-OpenWebUI-User-Id
          litellm_user_role: customer
        # Rate limiting is currently based on customer/end-user, which should use the user-id.
        # - header_name: X-OpenWebUI-User-Email
        #   litellm_user_role: customer
      enforce_user_param: false
      store_prompts_in_spend_logs: true
      custom_auth: custom_auth.user_api_key_auth
      custom_auth_settings:
        mode: "auto"
    
    router_settings:
      routing_strategy: "{{ .Values.router.routingStrategy }}"
      # Redis disabled - using simple-shuffle strategy doesn't require persistent state
      # redis_host: "{{ .Values.secrets.redisHost }}"
      # redis_port: {{ .Values.env.litellmRedisPort }}
      # redis_url: "{{ .Values.secrets.redisUrl }}"
    
    litellm_settings:
      cache: false
      drop_params: true
      extra_spend_tag_headers:
        - "x-openwebui-user-id"
        - "x-zuplo-user-id"
    
    model_list:
    {{- range .Values.config.models }}
    - model_name: {{ .model_name }}
      litellm_params:
        model: {{ .litellm_params.model }}
        {{- if .litellm_params.aws_region_name }}
        aws_region_name: {{ .litellm_params.aws_region_name }}
        {{- end }}
        {{- if .litellm_params.api_base }}
        api_base: {{ .litellm_params.api_base }}
        {{- end }}
        {{- if .litellm_params.api_key }}
        api_key: {{ .litellm_params.api_key | quote }}
        {{- end }}
    {{- end }}
    
    {{- if .Values.config.guardrails }}
    guardrails:
    {{- range .Values.config.guardrails }}
    - guardrail_name: {{ .guardrail_name | quote }}
      litellm_params:
        guardrail: {{ .litellm_params.guardrail }}
        mode: {{ .litellm_params.mode | quote }}
        guardrailIdentifier: {{ .litellm_params.guardrailIdentifier | quote }}
        guardrailVersion: {{ .litellm_params.guardrailVersion | quote }}
        aws_region_name: {{ .litellm_params.aws_region_name | quote }}
        {{- if .litellm_params.disable_exception_on_block }}
        disable_exception_on_block: {{ .litellm_params.disable_exception_on_block }}
        {{- end }}
        {{- if .litellm_params.default_on }}
        default_on: {{ .litellm_params.default_on }}
        {{- end }}
    {{- end }}
    {{- end }}