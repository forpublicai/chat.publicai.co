direction: up

# Users at top
users: {
  label: "Users"
  shape: person
  style.fill: "#374151"
}

# Load Balancer (outside cluster)
load_balancer: {
  label: "DO Load Balancer"
  shape: diamond
  style.fill: "#ff6b35"
  style.stroke: "#e55100"
}

# Managed Kubernetes Cluster: Platform Services
do_kubernetes: {
  label: "Managed Kubernetes Cluster"
  style.fill: "#dbeafe"
  style.stroke: "#3b82f6"
  
  # Ingress Nginx Namespace
  ingress_nginx_namespace: {
    label: "ingress-nginx namespace"
    style.fill: "#e8f5e8"
    style.stroke: "#4caf50"
    
    ingress_nginx: {
      label: "Ingress Nginx Controllers\nhost: app.publicai.company"
      shape: hexagon
      style.fill: "#4caf50"
      style.stroke: "#2e7d32"
    }
  }
  
  # Web Services Namespace
  web_services: {
    label: "web-services namespace"
    style.fill: "#f3e5f5"
    style.stroke: "#9c27b0"
    
    web_services_container: {
      label: "Web Services"
      style.fill: "#faf5ff"
      style.stroke: "#7c3aed"
      
      openwebui_service: {
        label: "openwebui-service"
        shape: oval
        style.fill: "#e1bee7"
      }
      
      
      searxng_service: {
        label: "searxng-service"
        shape: oval
        style.fill: "#6ee7b7"
      }
      
      tika_service: {
        label: "tika-service"
        shape: oval
        style.fill: "#c4b5fd"
      }
    }
    
    openwebui_pod_1: {
      label: "OpenWebUI Pod"
      shape: rectangle
      style.fill: "#3b82f6"
      style.stroke: "#1976d2"
    }
    
    openwebui_pod_2: {
      label: "OpenWebUI Pod"
      shape: rectangle
      style.fill: "#3b82f6"
      style.stroke: "#1976d2"
    }
    
    openwebui_pod_more: {
      label: "OpenWebUI Pod\n(more instances...)"
      shape: rectangle
      style.fill: "#3b82f6"
      style.stroke: "#1976d2"
      style.stroke-dash: 5
    }
    
    
    searxng_pod_1: {
      label: "SearXNG\nMetadata Search Engine"
      shape: rectangle
      style.fill: "#10b981"
    }
    
    searxng_pod_2: {
      label: "SearXNG\nMetadata Search Engine"
      shape: rectangle
      style.fill: "#10b981"
    }
    
    searxng_pod_more: {
      label: "SearXNG Pod\n(more instances...)"
      shape: rectangle
      style.fill: "#10b981"
      style.stroke-dash: 5
    }
    
    tika_pod_1: {
      label: "Apache Tika\nDocument Extraction"
      shape: rectangle
      style.fill: "#a855f7"
    }
    
    tika_pod_2: {
      label: "Apache Tika\nDocument Extraction"
      shape: rectangle
      style.fill: "#a855f7"
    }
    
    tika_pod_more: {
      label: "Apache Tika Pod\n(more instances...)"
      shape: rectangle
      style.fill: "#a855f7"
      style.stroke-dash: 5
    }
    
    web_services_container.openwebui_service -> openwebui_pod_1: "Routes traffic to pods"
    web_services_container.openwebui_service -> openwebui_pod_2: "Routes traffic to pods"
    web_services_container.openwebui_service -> openwebui_pod_more: "Routes traffic to pods"
    web_services_container.searxng_service -> searxng_pod_1: "Routes traffic to pods"
    web_services_container.searxng_service -> searxng_pod_2: "Routes traffic to pods"
    web_services_container.searxng_service -> searxng_pod_more: "Routes traffic to pods"
    web_services_container.tika_service -> tika_pod_1: "Routes traffic to pods"
    web_services_container.tika_service -> tika_pod_2: "Routes traffic to pods"
    web_services_container.tika_service -> tika_pod_more: "Routes traffic to pods"
  }
  
  # Connections within cluster
  ingress_nginx_namespace.ingress_nginx -> web_services.web_services_container.openwebui_service
}


# External services
cloudflare_cdn: {
  label: "Cloudflare CDN"
  shape: cloud
  style.fill: "#f97316"
}

zuplo_gateway: {
  label: "Zuplo Gateway - api.publicai.company"
  shape: cloud
  style.fill: "#e0e7ff"
  style.stroke: "#6366f1"
  style.font-color: "#1e1b4b"
  width: 1600
  height: 400
  
  authentication_policy: {
    label: "Authentication Policy\nAPI Key Validation"
    shape: hexagon
    style.fill: "#ef4444"
    style.stroke: "#dc2626"
    style.font-color: "#ffffff"
  }
  
  user_rate_limit_policy: {
    label: "User Rate Limiting Policy\n10 requests per minute"
    shape: diamond
    style.fill: "#fbbf24"
    style.stroke: "#f59e0b"
    style.font-color: "#92400e"
  }
  
  load_balancing_policies: {
    label: "Load Balancing Policies"
    style.fill: "#f8faff"
    style.stroke: "#6366f1"
    width: 500
    height: 200
    
    apertus_8b_lb_policy: {
      label: "apertus-8b Load Balancing"
      shape: oval
      style.fill: "#c084fc"
      style.stroke: "#9333ea"
      style.font-color: "#581c87"
    }
    
    apertus_70b_lb_policy: {
      label: "apertus-70b Load Balancing"
      shape: oval
      style.fill: "#a855f7"
      style.stroke: "#7c3aed"
      style.font-color: "#581c87"
    }
    
    other_models_policy: {
      label: "Other Models\n(Direct Routing)"
      shape: oval
      style.fill: "#94a3b8"
      style.stroke: "#64748b"
      style.font-color: "#1e293b"
    }
  }
}

developer_portal: {
  label: "Developer Portal\ndocs.publicai.company\nSelf-issue API Keys"
  shape: cloud
  style.fill: "#10b981"
  style.stroke: "#059669"
}

vercel: {
  label: "Vercel"
  style.fill: "#f3f4f6"
  style.stroke: "#d1d5db"
  marketing: {
    label: "Marketing Site\npublicai.company"
    shape: cloud
    style.fill: "#6b7280"
  }
}

openwebui_deps: {
  label: "OpenWebUI Data Layer"
  style.fill: "#f8fafc"
  style.stroke: "#e2e8f0"
  postgres: {
    label: "Managed PostgreSQL"
    shape: cylinder
    style.fill: "#0ea5e9"
  }
  redis: {
    label: "Managed Redis"
    shape: cylinder
    style.fill: "#ef4444"
  }
  spaces: {
    label: "AWS S3"
    shape: cloud
    style.fill: "#06b6d4"
  }
}

external_ai_providers: {
  label: "External AI Model Providers"
  style.fill: "#f8fafc"
  style.stroke: "#e2e8f0"
  swisscom: {
    label: "SwissCom API\n(apertus-8b, apertus-70b)"
    shape: cloud
    style.fill: "#f59e0b"
  }
  ai_singapore: {
    label: "AI Singapore API\n(SEA-LION models, apertus-8b, apertus-70b)"
    shape: cloud
    style.fill: "#84cc16"
  }
  bsc_api: {
    label: "BSC API\n(Salamandra models)"
    shape: cloud
    style.fill: "#8b5cf6"
  }
}

embedding_service: {
  label: "Embedding Service\n(AWS Bedrock / OpenAI / Cohere / Other)"
  shape: cloud
  style.fill: "#34d399"
  style.stroke: "#10b981"
}

reranking_service: {
  label: "Reranking Service\n(AWS Bedrock / OpenAI / Cohere / Other)"
  shape: cloud
  style.fill: "#6ee7b7"
  style.stroke: "#059669"
}

p4d_instances: {
  label: "Amazon P4D Instances\n6x instances\n8x NVIDIA A100 each\n96 vCPU each"
  style.fill: "#fee2e2"
  style.stroke: "#dc2626"
  
  apertus8b_service: {
    label: "apertus8b-service\n(Load Balancer)"
    shape: cloud
    style.fill: "#f97316"
    style.stroke: "#ea580c"
  }
  
  apertus70b_service: {
    label: "apertus70b-service\n(Load Balancer)"
    shape: cloud
    style.fill: "#dc2626"
    style.stroke: "#991b1b"
  }
  
  apertus_8b_instance_1: {
    label: "P4D Instance 1\nApertus 8B Model\nvLLM"
    shape: rectangle
    style.fill: "#f97316"
  }
  
  apertus_8b_instance_2: {
    label: "P4D Instance 2\nApertus 8B Model\nvLLM"
    shape: rectangle
    style.fill: "#f97316"
  }
  
  apertus_8b_instance_3: {
    label: "P4D Instance 3\nApertus 8B Model\nvLLM"
    shape: rectangle
    style.fill: "#f97316"
  }
  
  apertus_70b_instance_1: {
    label: "P4D Instance 4\nApertus 70B Model\nvLLM"
    shape: rectangle
    style.fill: "#dc2626"
  }
  
  apertus_70b_instance_2: {
    label: "P4D Instance 5\nApertus 70B Model\nvLLM"
    shape: rectangle
    style.fill: "#dc2626"
  }
  
  apertus_70b_instance_3: {
    label: "P4D Instance 6\nApertus 70B Model\nvLLM"
    shape: rectangle
    style.fill: "#dc2626"
  }
}

# Connections
users -> vercel.marketing: "Browse"
users -> cloudflare_cdn: "App Access"
cloudflare_cdn -> load_balancer: "HTTP/HTTPS Traffic\napp.publicai.company"
load_balancer -> do_kubernetes.ingress_nginx_namespace.ingress_nginx

do_kubernetes.web_services.web_services_container.openwebui_service -> openwebui_deps.postgres
do_kubernetes.web_services.web_services_container.openwebui_service -> openwebui_deps.redis
do_kubernetes.web_services.web_services_container.openwebui_service -> openwebui_deps.spaces

do_kubernetes.web_services.web_services_container.openwebui_service -> zuplo_gateway.authentication_policy: "AI Model Requests"
developer_portal -> zuplo_gateway.authentication_policy: "API Key Requests"

zuplo_gateway.authentication_policy -> zuplo_gateway.user_rate_limit_policy: "Authenticated Requests"
zuplo_gateway.user_rate_limit_policy -> zuplo_gateway.load_balancing_policies: "Rate Limited Requests"
do_kubernetes.web_services.web_services_container.openwebui_service -> do_kubernetes.web_services.web_services_container.searxng_service: "Search Requests"
do_kubernetes.web_services.web_services_container.openwebui_service -> do_kubernetes.web_services.web_services_container.tika_service: "Document Processing"

zuplo_gateway -> embedding_service: "/v1/embeddings"
zuplo_gateway -> reranking_service: "/v1/rerank"

zuplo_gateway.load_balancing_policies.apertus_8b_lb_policy -> p4d_instances.apertus8b_service: "/v1/chat/completions\n(model: apertus-8b)"
zuplo_gateway.load_balancing_policies.apertus_8b_lb_policy -> external_ai_providers.ai_singapore: "/v1/chat/completions\n(model: apertus-8b)"
zuplo_gateway.load_balancing_policies.apertus_8b_lb_policy -> external_ai_providers.swisscom: "/v1/chat/completions\n(model: apertus-8b)"
zuplo_gateway.load_balancing_policies.apertus_70b_lb_policy -> p4d_instances.apertus70b_service: "/v1/chat/completions\n(model: apertus-70b)"
zuplo_gateway.load_balancing_policies.apertus_70b_lb_policy -> external_ai_providers.ai_singapore: "/v1/chat/completions\n(model: apertus-70b)"
zuplo_gateway.load_balancing_policies.apertus_70b_lb_policy -> external_ai_providers.swisscom: "/v1/chat/completions\n(model: apertus-70b)"
zuplo_gateway.load_balancing_policies.other_models_policy -> external_ai_providers.ai_singapore: "/v1/chat/completions\n(model: sea-lion-*)"
zuplo_gateway.load_balancing_policies.other_models_policy -> external_ai_providers.bsc_api: "/v1/chat/completions\n(model: salamandra-7b)"

p4d_instances.apertus8b_service -> p4d_instances.apertus_8b_instance_1: "Load balances"
p4d_instances.apertus8b_service -> p4d_instances.apertus_8b_instance_2: "Load balances"
p4d_instances.apertus8b_service -> p4d_instances.apertus_8b_instance_3: "Load balances"
p4d_instances.apertus70b_service -> p4d_instances.apertus_70b_instance_1: "Load balances"
p4d_instances.apertus70b_service -> p4d_instances.apertus_70b_instance_2: "Load balances"
p4d_instances.apertus70b_service -> p4d_instances.apertus_70b_instance_3: "Load balances"

