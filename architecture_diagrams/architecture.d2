direction: down

# Users at top
users: {
  label: "Users"
  shape: person
  style.fill: "#374151"
}

# DigitalOcean Managed Kubernetes Cluster
do_kubernetes: {
  label: "DigitalOcean Managed Kubernetes Cluster\nAutoscaling: 1-10 nodes"
  style.fill: "#0080ff"
  style.stroke: "#0066cc"
  
  # Load Balancer
  load_balancer: {
    label: "DO Load Balancer\n129.212.192.117\nPorts 80/443"
    shape: diamond
    style.fill: "#ff6b35"
    style.stroke: "#e55100"
  }
  
  # Ingress Controller
  ingress_nginx: {
    label: "Ingress Nginx Controllers\n(2 pods)\nhost: app.publicai.company"
    shape: hexagon
    style.fill: "#4caf50"
    style.stroke: "#2e7d32"
  }
  
  # Web Services Namespace
  web_services: {
    label: "web-services namespace"
    style.fill: "#f3e5f5"
    style.stroke: "#9c27b0"
    
    openwebui_service: {
      label: "openwebui-service\nClusterIP: 10.108.54.188\nPort 8080"
      shape: oval
      style.fill: "#e1bee7"
    }
    
    openwebui_pods: {
      label: "OpenWebUI Pods\n(2 replicas)\napp.publicai.company"
      shape: rectangle
      style.fill: "#3b82f6"
      style.stroke: "#1976d2"
    }
    
    grafana_pods: {
      label: "Grafana Pods\ngrafana.publicai.company"
      shape: rectangle
      style.fill: "#6366f1"
      style.stroke: "#3949ab"
    }
  }
  
  # Worker Nodes
  worker_nodes: {
    label: "Worker Nodes\n(1-10 autoscaling)\npool-hgpgo86kh"
    shape: rectangle
    style.fill: "#ffecb3"
    style.stroke: "#ff8f00"
    style.stroke-dash: 3
  }
  
  # Connections within cluster
  load_balancer -> ingress_nginx
  ingress_nginx -> web_services.openwebui_service
  ingress_nginx -> web_services.grafana_pods
  web_services.openwebui_service -> web_services.openwebui_pods
  web_services.openwebui_pods -> web_services.grafana_pods: "Telemetry"
}

gpu_droplet: {
  label: "DO GPU Droplet / AWS EC2\nRTX 6000 Ada - 48GB VRAM"
  style.fill: "#fef3c7"
  style.stroke: "#f59e0b"
  
  ai_gateway: {
    label: "AI Gateway Layer"
    style.fill: "#f9fafb"
    style.stroke: "#e5e7eb"
    envoy: {
      label: "Envoy Proxy\nAI API Gateway"
      shape: rectangle
      style.fill: "#8b5cf6"
    }
    tika: {
      label: "Apache Tika\nDocument Extraction"
      shape: rectangle
      style.fill: "#a855f7"
    }
  }
  
  local_models: {
    label: "Local AI Models"
    style.fill: "#ecfdf5"
    style.stroke: "#10b981"
    bge_m3: {
      label: "BGE-M3\nEmbedding Model\nvLLM"
      shape: rectangle
      style.fill: "#34d399"
    }
    bge_reranker: {
      label: "BGE-reranker-v2.5\nReranking Model\nvLLM"
      shape: rectangle
      style.fill: "#6ee7b7"
    }
    task_model: {
      label: "Future Task Models\n(Classification, etc.)"
      shape: rectangle
      style.fill: "#a7f3d0"
      style.stroke-dash: 5
    }
  }
  
  ai_gateway.envoy -> local_models.bge_m3
  ai_gateway.envoy -> local_models.bge_reranker
  ai_gateway.envoy -> local_models.task_model
  ai_gateway.envoy -> ai_gateway.tika
}

apertus_droplet: {
  label: "DO GPU Droplet / AWS EC2\nApertus Model on vLLM"
  style.fill: "#fef3c7"
  style.stroke: "#f59e0b"
  
  apertus_model: {
    label: "Apertus Model\nvLLM"
    shape: rectangle
    style.fill: "#f97316"
  }
}

# External services
cloudflare: {
  label: "Cloudflare CDN"
  style.fill: "#f97316"
  style.stroke: "#ea580c"
  cdn: {
    label: "Edge Locations\nSSL Termination\nDDoS Protection\nSubdomain Routing"
    shape: cloud
    style.fill: "#fb923c"
  }
}

vercel: {
  label: "Vercel"
  style.fill: "#f3f4f6"
  style.stroke: "#d1d5db"
  marketing: {
    label: "Marketing Site\npublicai.company"
    shape: cloud
    style.fill: "#6b7280"
  }
}

openwebui_deps: {
  label: "OpenWebUI Data Layer"
  style.fill: "#f8fafc"
  style.stroke: "#e2e8f0"
  postgres: {
    label: "Managed PostgreSQL"
    shape: cylinder
    style.fill: "#0ea5e9"
  }
  redis: {
    label: "Managed Redis"
    shape: cylinder
    style.fill: "#ef4444"
  }
  spaces: {
    label: "AWS S3"
    shape: cloud
    style.fill: "#06b6d4"
  }
}

external_ai_providers: {
  label: "External AI Model Providers"
  style.fill: "#f8fafc"
  style.stroke: "#e2e8f0"
  swisscom: {
    label: "SwissCom API"
    shape: cloud
    style.fill: "#f59e0b"
  }
  sealion: {
    label: "Sea Lion API\nAI Singapore"
    shape: cloud
    style.fill: "#84cc16"
  }
}

# Connections
users -> vercel.marketing: "Browse"
users -> cloudflare.cdn: "App Access"
cloudflare.cdn -> do_kubernetes.load_balancer: "HTTP/HTTPS Traffic\napp.publicai.company"

do_kubernetes.web_services.openwebui_pods -> openwebui_deps.postgres
do_kubernetes.web_services.openwebui_pods -> openwebui_deps.redis
do_kubernetes.web_services.openwebui_pods -> openwebui_deps.spaces

do_kubernetes.web_services.openwebui_pods -> gpu_droplet.ai_gateway.envoy: "AI Model Requests & Document Processing"

gpu_droplet.ai_gateway.envoy -> external_ai_providers.swisscom: "API Requests"
gpu_droplet.ai_gateway.envoy -> external_ai_providers.sealion: "API Requests"
gpu_droplet.ai_gateway.envoy -> apertus_droplet.apertus_model: "Model Requests"

gpu_droplet.ai_gateway.envoy -> do_kubernetes.web_services.grafana_pods: "API Metrics & Telemetry"