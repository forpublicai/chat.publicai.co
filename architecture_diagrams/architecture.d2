direction: down

# Users at top
users: {
  label: "Users"
  shape: person
  style.fill: "#374151"
}

# Load Balancer (outside cluster)
load_balancer: {
  label: "DO Load Balancer"
  shape: diamond
  style.fill: "#ff6b35"
  style.stroke: "#e55100"
}

# Managed Kubernetes Cluster: Platform Services
do_kubernetes: {
  label: "Managed Kubernetes Cluster: Platform Services"
  style.fill: "#dbeafe"
  style.stroke: "#3b82f6"
  
  # Ingress Nginx Namespace
  ingress_nginx_namespace: {
    label: "ingress-nginx namespace"
    style.fill: "#e8f5e8"
    style.stroke: "#4caf50"
    
    ingress_nginx: {
      label: "Ingress Nginx Controllers\nhost: app.publicai.company"
      shape: hexagon
      style.fill: "#4caf50"
      style.stroke: "#2e7d32"
    }
  }
  
  # Web Services Namespace
  web_services: {
    label: "web-services namespace"
    style.fill: "#f3e5f5"
    style.stroke: "#9c27b0"
    
    openwebui_service: {
      label: "openwebui-service"
      shape: oval
      style.fill: "#e1bee7"
    }
    
    openwebui_pod_1: {
      label: "OpenWebUI Pod"
      shape: rectangle
      style.fill: "#3b82f6"
      style.stroke: "#1976d2"
    }
    
    openwebui_pod_2: {
      label: "OpenWebUI Pod"
      shape: rectangle
      style.fill: "#3b82f6"
      style.stroke: "#1976d2"
    }
    
    openwebui_pod_more: {
      label: "OpenWebUI Pod\n(more instances...)"
      shape: rectangle
      style.fill: "#3b82f6"
      style.stroke: "#1976d2"
      style.stroke-dash: 5
    }
    
    zuplo_service: {
      label: "zuplo-service"
      shape: oval
      style.fill: "#c084fc"
    }
    
    zuplo_pod_1: {
      label: "Zuplo Gateway"
      shape: rectangle
      style.fill: "#8b5cf6"
    }
    
    zuplo_pod_2: {
      label: "Zuplo Gateway"
      shape: rectangle
      style.fill: "#8b5cf6"
    }
    
    zuplo_pod_more: {
      label: "Zuplo Pod\n(more instances...)"
      shape: rectangle
      style.fill: "#8b5cf6"
      style.stroke-dash: 5
    }
    
    searxng_service: {
      label: "searxng-service"
      shape: oval
      style.fill: "#6ee7b7"
    }
    
    searxng_pod_1: {
      label: "SearXNG\nMetadata Search Engine"
      shape: rectangle
      style.fill: "#10b981"
    }
    
    searxng_pod_2: {
      label: "SearXNG\nMetadata Search Engine"
      shape: rectangle
      style.fill: "#10b981"
    }
    
    searxng_pod_more: {
      label: "SearXNG Pod\n(more instances...)"
      shape: rectangle
      style.fill: "#10b981"
      style.stroke-dash: 5
    }
    
    tika_service: {
      label: "tika-service"
      shape: oval
      style.fill: "#c4b5fd"
    }
    
    tika_pod_1: {
      label: "Apache Tika\nDocument Extraction"
      shape: rectangle
      style.fill: "#a855f7"
    }
    
    tika_pod_2: {
      label: "Apache Tika\nDocument Extraction"
      shape: rectangle
      style.fill: "#a855f7"
    }
    
    tika_pod_more: {
      label: "Apache Tika Pod\n(more instances...)"
      shape: rectangle
      style.fill: "#a855f7"
      style.stroke-dash: 5
    }
    
    openwebui_service -> openwebui_pod_1: "Routes traffic to pods"
    openwebui_service -> openwebui_pod_2: "Routes traffic to pods"
    openwebui_service -> openwebui_pod_more: "Routes traffic to pods"
    zuplo_service -> zuplo_pod_1: "Routes traffic to pods"
    zuplo_service -> zuplo_pod_2: "Routes traffic to pods"
    zuplo_service -> zuplo_pod_more: "Routes traffic to pods"
    searxng_service -> searxng_pod_1: "Routes traffic to pods"
    searxng_service -> searxng_pod_2: "Routes traffic to pods"
    searxng_service -> searxng_pod_more: "Routes traffic to pods"
    tika_service -> tika_pod_1: "Routes traffic to pods"
    tika_service -> tika_pod_2: "Routes traffic to pods"
    tika_service -> tika_pod_more: "Routes traffic to pods"
  }
  
  # Connections within cluster
  ingress_nginx_namespace.ingress_nginx -> web_services.openwebui_service
}

ai_services_cluster: {
  label: "Managed Kubernetes Cluster: AI Services"
  style.fill: "#f3e8ff"
  style.stroke: "#8b5cf6"
  
  bge_m3_service: {
    label: "bge-m3-service"
    shape: oval
    style.fill: "#86efac"
  }
  
  bge_m3_pod_1: {
    label: "BGE-M3\nEmbedding Model\nvLLM"
    shape: rectangle
    style.fill: "#34d399"
  }
  
  bge_m3_pod_2: {
    label: "BGE-M3\nEmbedding Model\nvLLM"
    shape: rectangle
    style.fill: "#34d399"
  }
  
  bge_m3_pod_more: {
    label: "BGE-M3 Pod\nvLLM\n(more instances...)"
    shape: rectangle
    style.fill: "#34d399"
    style.stroke-dash: 5
  }
  
  bge_reranker_service: {
    label: "bge-reranker-service"
    shape: oval
    style.fill: "#86efac"
  }
  
  bge_reranker_pod_1: {
    label: "BGE-reranker-v2.5\nReranking Model\nvLLM"
    shape: rectangle
    style.fill: "#6ee7b7"
  }
  
  bge_reranker_pod_2: {
    label: "BGE-reranker-v2.5\nReranking Model\nvLLM"
    shape: rectangle
    style.fill: "#6ee7b7"
  }
  
  bge_reranker_pod_more: {
    label: "BGE-reranker Pod\nvLLM\n(more instances...)"
    shape: rectangle
    style.fill: "#6ee7b7"
    style.stroke-dash: 5
  }
  
  apertus_service: {
    label: "apertus-service"
    shape: oval
    style.fill: "#fb923c"
  }
  
  apertus_model_1: {
    label: "Apertus Model\nvLLM"
    shape: rectangle
    style.fill: "#f97316"
  }
  
  apertus_model_2: {
    label: "Apertus Model\nvLLM"
    shape: rectangle
    style.fill: "#f97316"
  }
  
  apertus_model_more: {
    label: "Apertus Model\nvLLM\n(more instances...)"
    shape: rectangle
    style.fill: "#f97316"
    style.stroke-dash: 5
  }
  
  bge_m3_service -> bge_m3_pod_1: "Routes traffic to pods"
  bge_m3_service -> bge_m3_pod_2: "Routes traffic to pods"
  bge_m3_service -> bge_m3_pod_more: "Routes traffic to pods"
  bge_reranker_service -> bge_reranker_pod_1: "Routes traffic to pods"
  bge_reranker_service -> bge_reranker_pod_2: "Routes traffic to pods"
  bge_reranker_service -> bge_reranker_pod_more: "Routes traffic to pods"
  apertus_service -> apertus_model_1: "Routes traffic to pods"
  apertus_service -> apertus_model_2: "Routes traffic to pods"
  apertus_service -> apertus_model_more: "Routes traffic to pods"
}

# External services
cloudflare_cdn: {
  label: "Cloudflare CDN"
  shape: cloud
  style.fill: "#f97316"
}

vercel: {
  label: "Vercel"
  style.fill: "#f3f4f6"
  style.stroke: "#d1d5db"
  marketing: {
    label: "Marketing Site\npublicai.company"
    shape: cloud
    style.fill: "#6b7280"
  }
}

openwebui_deps: {
  label: "OpenWebUI Data Layer"
  style.fill: "#f8fafc"
  style.stroke: "#e2e8f0"
  postgres: {
    label: "Managed PostgreSQL"
    shape: cylinder
    style.fill: "#0ea5e9"
  }
  redis: {
    label: "Managed Redis"
    shape: cylinder
    style.fill: "#ef4444"
  }
  spaces: {
    label: "AWS S3"
    shape: cloud
    style.fill: "#06b6d4"
  }
}

external_ai_providers: {
  label: "External AI Model Providers"
  style.fill: "#f8fafc"
  style.stroke: "#e2e8f0"
  swisscom: {
    label: "SwissCom API\n(Apertus models)"
    shape: cloud
    style.fill: "#f59e0b"
  }
  ai_singapore: {
    label: "AI Singapore API\n(Apertus models)"
    shape: cloud
    style.fill: "#84cc16"
  }
  sealion_api: {
    label: "SEA-LION API\n(SEA-LION models)"
    shape: cloud
    style.fill: "#06b6d4"
  }
  bsc_api: {
    label: "BSC API\n(Salamandra models)"
    shape: cloud
    style.fill: "#8b5cf6"
  }
}

# Connections
users -> vercel.marketing: "Browse"
users -> cloudflare_cdn: "App Access"
cloudflare_cdn -> load_balancer: "HTTP/HTTPS Traffic\napp.publicai.company"
load_balancer -> do_kubernetes.ingress_nginx_namespace.ingress_nginx

do_kubernetes.web_services.openwebui_service -> openwebui_deps.postgres
do_kubernetes.web_services.openwebui_service -> openwebui_deps.redis
do_kubernetes.web_services.openwebui_service -> openwebui_deps.spaces

do_kubernetes.web_services.openwebui_service -> do_kubernetes.web_services.zuplo_service: "AI Model Requests"
do_kubernetes.web_services.openwebui_service -> do_kubernetes.web_services.searxng_service: "Search Requests"
do_kubernetes.web_services.openwebui_service -> do_kubernetes.web_services.tika_service: "Document Processing"

do_kubernetes.web_services.zuplo_service -> ai_services_cluster.bge_m3_service: "/v1/embeddings\n(model: bge-m3)"
do_kubernetes.web_services.zuplo_service -> ai_services_cluster.bge_reranker_service: "/v1/rerank\n(model: bge-reranker-v2.5)"
do_kubernetes.web_services.zuplo_service -> external_ai_providers.swisscom: "/v1/chat/completions\n(model: apertus-7b)"
do_kubernetes.web_services.zuplo_service -> external_ai_providers.ai_singapore: "/v1/chat/completions\n(model: apertus-7b)"
do_kubernetes.web_services.zuplo_service -> external_ai_providers.sealion_api: "/v1/chat/completions\n(model: sea-lion-7b)"
do_kubernetes.web_services.zuplo_service -> external_ai_providers.bsc_api: "/v1/chat/completions\n(model: salamandra-7b)"
do_kubernetes.web_services.zuplo_service -> ai_services_cluster.apertus_service: "/v1/chat/completions\n(model: apertus-7b)"

